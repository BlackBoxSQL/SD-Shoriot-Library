## 12. [How to Deploy a Django Application to Digital Ocean](https://simpleisbetterthancomplex.com/tutorial/2016/10/14/how-to-deploy-to-digital-ocean.html) by Vitor Freitas.

#### or you can try it.

###### DigitalOcean is a Virtual Private Server (VPS) provider. In this tutorial I will guide you through the steps I go to deploy a Django application using 
* Ubuntu 16.04
* Git 
* PostgreSQL
* NGINX
* Supervisor
* Gunicorn

1. Go to: [Digital Ocean](https://www.digitalocean.com/) then Sing Up & Login

2. Create a New Droplet:
```python
Pick the Ubuntu 16.04.1 distribution:
```
3. Select the size of the Droplet (cloud server):
```python
Like: $ 5/month or $ 10/month
```
4. Select the region you want to deploy:
```python
Like: New York or London
```
5. Finally pick a name for the Droplet & click on Create. After that you will see the recently created droplet in your profile:

6. You will receive the root password via email. Now pick the IP Address and ssh into the server:
```python
$ ssh root@107.170.28.172
```
* You will be asked to change the root password upon the first login.

* Also if you prefer, you can use the Digital Ocean’s console:

7. Installing the Server Dependencies

* First thing let’s upgrade the packages:
```python
$ sudo apt-get update
$ sudo apt-get -y upgrade
```
8. PostgreSQL

* Install the dependencies to use PostgreSQL with Python/Django:
```python
$ sudo apt-get -y install build-essential libpq-dev python-dev
```
* Install the PostgreSQL Server:
```python
$ sudo apt-get -y install postgresql postgresql-contrib
```

9. NGINX

* Install NGINX, which will be used to serve static assets (css, js, images) and also to run the Django application behind a proxy server:
```python
$ sudo apt-get -y install nginx
```

10. Supervisor

* Supervisor will start the application server and manage it in case of server crash or restart:
```python
$ sudo apt-get -y install supervisor
```
* Enable and start the Supervisor:
```python
$ sudo systemctl enable supervisor

$ sudo systemctl start supervisor
```

11. Python Virtualenv

* The Django application will be deployed inside a Python Virtualenv, for a better requirements management:

```python
$ sudo apt-get -y install python-virtualenv
```

12. Configure PostgreSQL Database

* Switch users:
```python
$ su - postgres
```
* Create a database user and the application database:
```python
$ createuser u_urban
$ createdb urban_prod --owner u_urban
$ psql -c "ALTER USER u_urban WITH PASSWORD '123'"
```

* PS: Make sure to pick a secure password! I’m using 123 for simplicity sake.

* We can now go back to the root user, simply exit:
```python
$ exit
```

13. Configure The Application User

* Create a new user with the command below:
```python
$ adduser urban
```
* Usually I just use the application name. You will be asked a few questions.

* Add the user to the list of sudoers:
```python
$ gpasswd -a urban sudo
```
* Switch to the recently created user:
```python
$ su - urban
```

14. Configure the Python Virtualenv

* At this point we are logged in with the urban user (or whatever named you selected). We will install our Django application in this user’s home directory /home/urban:
```python
$ virtualenv .
$ source bin/activate
```
* Clone the repository:
```python
$ git clone
```
* First open the urban-train directory:
```python
$ cd urban-train
```
* Install the project’s dependencies:
```python
$ pip install -r requirements.txt
```
* At this point you will need to set the database credentials in the settings.py file:
```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql_psycopg2',
        'NAME': 'urban_prod',
        'USER': 'u_urban',
        'PASSWORD': '123',
        'HOST': 'localhost',
        'PORT': '',
    }
}
```
* PS: There are better and secure ways to handle SECRET_KEY, database credentials etc. I’m editing it directly in the settings.py file for the sake of simplicity. The focus of this tutorial is on the deployment process itself.

* Migrate the database:
```python
$ python manage.py migrate
```
* Collect the static files:
```python
$ python manage.py collectstatic
```
* Test if everything is okay:
```python
$ python manage.py runserver 0.0.0.0:8000
```
* Access the IP Address of your server using port 8000. In my case, 107.170.28.172:8000.

* This is just a test. We won’t be using the runserver to run our application. We will be using a proper application server to securely serve our application.

* Hit CONTROL-C to quit the development server and let’s keep moving forward.

15. Configure Gunicorn

* First install Gunicorn inside the virtualenv:
```python
$ pip install gunicorn
```
* Create a file named gunicorn_start inside the bin/ folder:
```python
$ vim bin/gunicorn_start
```
* And add the following information and save it:
* /home/urban/bin/gunicorn_start
```python
#!/bin/bash

NAME="urban_train"
DIR=/home/urban/urban-train
USER=urban
GROUP=urban
WORKERS=3
BIND=unix:/home/urban/run/gunicorn.sock
DJANGO_SETTINGS_MODULE=urban_train.settings
DJANGO_WSGI_MODULE=urban_train.wsgi
LOG_LEVEL=error

cd $DIR
source ../bin/activate

export DJANGO_SETTINGS_MODULE=$DJANGO_SETTINGS_MODULE
export PYTHONPATH=$DIR:$PYTHONPATH

exec ../bin/gunicorn ${DJANGO_WSGI_MODULE}:application \
  --name $NAME \
  --workers $WORKERS \
  --user=$USER \
  --group=$GROUP \
  --bind=$BIND \
  --log-level=$LOG_LEVEL \
  --log-file=-
```
* Make the gunicorn_start file is executable:
```python
$ chmod u+x bin/gunicorn_start
```
* Create a directory named run, for the unix socket file:
```python
$ mkdir run
```

16. Configure Supervisor

* Create a folder named logs inside the virtualenv:
```python
$ mkdir logs
```
* Create a file to be used to log the application errors:
```python
$ touch logs/gunicorn-error.log
```
* Create a new Supervisor configuration file:
```python
$ sudo vim /etc/supervisor/conf.d/urban-train.conf
```
* /etc/supervisor/conf.d/urban-train.conf
```python
[program:urban-train]
command=/home/urban/bin/gunicorn_start
user=urban
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/home/urban/logs/gunicorn-error.log
```
* Reread Supervisor configuration files and make the new program available:
```python
$ sudo supervisorctl reread
$ sudo supervisorctl update
```
* Check the status:
```python
$ sudo supervisorctl status urban-train
$ urban-train                      RUNNING   pid 23381, uptime 0:00:15
```
* Now you can control your application using Supervisor. If you want to update the source code of your application with a new version, you can pull the code from GitHub and then restart the process:
```python
$ sudo supervisorctl restart urban-train
```
* Where urban-train will be the name of your application.


17. Configure NGINX

* Add a new configuration file named urban inside /etc/nginx/sites-available/:
```python
$ sudo vim /etc/nginx/sites-available/urban-train
```
* /etc/nginx/sites-available/urban-train
```python
upstream app_server {
    server unix:/home/urban/run/gunicorn.sock fail_timeout=0;
}

server {
    listen 80;

    # add here the ip address of your server
    # or a domain pointing to that ip (like example.com or www.example.com)
    server_name 107.170.28.172;

    keepalive_timeout 5;
    client_max_body_size 4G;

    access_log /home/urban/logs/nginx-access.log;
    error_log /home/urban/logs/nginx-error.log;

    location /static/ {
        alias /home/urban/static/;
    }

    # checks for static file, if not found proxy to app
    location / {
        try_files $uri @proxy_to_app;
    }

    location @proxy_to_app {
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_redirect off;
      proxy_pass http://app_server;
    }
}
```
* Create a symbolic link to the sites-enabled dir:
```python
$ sudo ln -s /etc/nginx/sites-available/urban-train /etc/nginx/sites-enabled/urban-train
```
* Remove NGINX default website:
```python
$ sudo rm /etc/nginx/sites-enabled/default
```

* Restart NGINX:
```python
$ sudo service nginx restart
```

18. The Final Test

---

> Please inbox **[me](https://www.facebook.com/shoriot)** if you've any questions.